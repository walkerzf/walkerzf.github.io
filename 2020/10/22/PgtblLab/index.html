<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>6.S081 Pgtbl Lab | Zat &#39;s Blog</title>
  <meta name="description" content="Pgtbl Lab  In this lab , we will explore the user page tables and kernel page table ,and modify or create a process‘s kernel page table to help simplify the functions that copy data from user space in">
<meta property="og:type" content="article">
<meta property="og:title" content="6.S081 Pgtbl Lab">
<meta property="og:url" content="https://walkerzf.github.io/2020/10/22/PgtblLab/index.html">
<meta property="og:site_name" content="Zat&#39;s Blog">
<meta property="og:description" content="Pgtbl Lab  In this lab , we will explore the user page tables and kernel page table ,and modify or create a process‘s kernel page table to help simplify the functions that copy data from user space in">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-10-22T15:13:14.000Z">
<meta property="article:modified_time" content="2020-10-28T14:19:24.516Z">
<meta property="article:author" content="Zhou Fang">
<meta property="article:tag" content="Lab">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="https://walkerzf.github.io/2020/10/22/PgtblLab/index.html">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Zat's Blog" type="application/atom+xml">
</head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/walkerzf" target="_blank">
          <img class="img-circle img-rotate" src="/images/Halu.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Zhou Fang</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Learner .Want to be a thinker.</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Hang Zhou, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">Repository</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">Books</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">Links</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/walkzf" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>Welcome to my Blog!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/6-S081/">6.S081</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/intro/">intro</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lab/" rel="tag">Lab</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/intro/" rel="tag">intro</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Lab/" style="font-size: 14px;">Lab</a> <a href="/tags/intro/" style="font-size: 13px;">intro</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/6-S081/">6.S081</a>
              </p>
              <p class="item-title">
                <a href="/2020/10/28/TrapLab/" class="title">6.S081 Traps Lab</a>
              </p>
              <p class="item-date">
                <time datetime="2020-10-28T12:00:00.000Z" itemprop="datePublished">2020-10-28</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/6-S081/">6.S081</a>
              </p>
              <p class="item-title">
                <a href="/2020/10/22/PgtblLab/" class="title">6.S081 Pgtbl Lab</a>
              </p>
              <p class="item-date">
                <time datetime="2020-10-22T15:13:14.000Z" itemprop="datePublished">2020-10-22</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/intro/">intro</a>
              </p>
              <p class="item-title">
                <a href="/2020/10/15/hello-world/" class="title">Introduction</a>
              </p>
              <p class="item-date">
                <time datetime="2020-10-15T12:14:25.000Z" itemprop="datePublished">2020-10-15</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">Catalogue</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Pgtbl-Lab"><span class="toc-number">1.</span> <span class="toc-text">Pgtbl Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Part-1-print-a-page-table"><span class="toc-number">2.</span> <span class="toc-text">Part 1 print a page table</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Part-2-A-kernel-page-table-per-process"><span class="toc-number">3.</span> <span class="toc-text">Part 2  A kernel page table per process</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-init-of-process-kernel-page-table"><span class="toc-number">3.1.</span> <span class="toc-text">The init of process kernel page table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-clean-of-process-kernel-page-table"><span class="toc-number">3.2.</span> <span class="toc-text">The clean of process kernel page table</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Part-3-Add-user-mapping"><span class="toc-number">4.</span> <span class="toc-text">Part 3 Add user mapping</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-PgtblLab" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      6.S081 Pgtbl Lab
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2020/10/22/PgtblLab/" class="article-date">
	  <time datetime="2020-10-22T15:13:14.000Z" itemprop="datePublished">2020-10-22</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/6-S081/">6.S081</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/Lab/" rel="tag">Lab</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/10/22/PgtblLab/#comments" class="article-comment-link">Comments</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="Pgtbl-Lab"><a href="#Pgtbl-Lab" class="headerlink" title="Pgtbl Lab"></a>Pgtbl Lab</h1><p>  In this lab , we will explore the user page tables and kernel page table ,and modify or create a process‘s kernel page table to help simplify the functions that copy data from user space into the kernel space.</p>
<p>  The lab have three parts. Part 1  is simpler relatively,we need to print the <strong>valid</strong> <code>pte</code> in three-level page table. Part 2 and 3 can be seen as one part .In part 2 ,we need to copy a process’s page table which is identical to kernel page table ,and in part 3 ,we need to add user mapping to the process’s kernel page table .</p>
<h1 id="Part-1-print-a-page-table"><a href="#Part-1-print-a-page-table" class="headerlink" title="Part 1 print a page table"></a>Part 1 print a page table</h1><p>  In this part ,we need to print the first process ‘ page table ,so we can see the figure 1 ,which is the use address space .The user address space have several parts : <code>text</code>,<code>data</code> ,<code>guard page</code> , <code>stack</code>,<code>trampoline</code> and <code>trapframe</code> .</p>
<p>  From the function <code>freewalk</code> .which is recursively free page-table pages ,we can find that we need to recursively print the page table. And we have three-level depth page table , so we need a variable to record the depth of the recursion in the helper function.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Recursively free page-table pages.</span></span><br><span class="line"><span class="comment">// All leaf mappings must already have been removed.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freewalk</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable)</span></span>&#123;</span><br><span class="line">  <span class="comment">// there are 2^9 = 512 PTEs in a page table.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">pte_t</span> pte = pagetable[i];</span><br><span class="line">    <span class="keyword">if</span> ((pte &amp; PTE_V) &amp;&amp; (pte &amp; (PTE_R | PTE_W | PTE_X)) == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">// this PTE points to a lower-level page table.</span></span><br><span class="line">      uint64 child = PTE2PA(pte);</span><br><span class="line">      freewalk((<span class="keyword">pagetable_t</span>)child);</span><br><span class="line">      pagetable[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pte &amp; PTE_V)&#123;</span><br><span class="line">      panic(<span class="string">"freewalk: leaf"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  kfree((<span class="keyword">void</span> *)pagetable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  We can have the function like these.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//heplerfunction for vmprint</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">helpervmprint</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, <span class="keyword">int</span> level)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (level &gt; <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">pte_t</span> pte = pagetable[i];</span><br><span class="line">    <span class="keyword">if</span> ((pte &amp; PTE_V))&#123;</span><br><span class="line">      <span class="comment">//this pte pointer to a lower-level page table</span></span><br><span class="line">      uint64 child = PTE2PA(pte);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= level; j++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">".."</span>);</span><br><span class="line">        <span class="keyword">if</span> (j != level)</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">" "</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%d: pte %p pa %p\n"</span>, i, pte, child);</span><br><span class="line">      helpervmprint((<span class="keyword">pagetable_t</span>)child, level + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//function to help print the contents of a page table</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vmprint</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable)</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"page table %p\n"</span>, pagetable);</span><br><span class="line">  helpervmprint(pagetable, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  We can get the output like this. In the top-level page table ,we have two entry. The first entry corresponding 1GB address. In the bottom page table ,we have three entries  ,corresponding the <code>text and data</code> ,<code>guard page</code> and <code>stack</code>.  The second entry in top-level page table ,  corresponding the <code>trampoline</code> and <code>tramframe</code> . We have two interesting points.</p>
<ul>
<li>The reason about the <code>text and data</code> are mapped together not respectively only for simplicity.</li>
<li>The <code>trampoline</code>  and <code>tramframe</code> are mapped highest in va , but in page table ,they are in entry <code>255</code>,not in <code>511</code>,because  although the <code>riscv</code>  uses 39-bits,it actually uses 38 bits ( because  if we use the 39th bit ,the 40th 41th 42th ..etc should be set <strong>All for simplicity! But still support for the future!</strong>) , so in the top-level page table ,we only have 8 bits, the highest bit is <code>255</code>.</li>
</ul>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">page table 0x0000000087f6e000</span><br><span class="line">..0: pte 0x0000000021fda801 pa 0x0000000087f6a000</span><br><span class="line">.. ..0: pte 0x0000000021fda401 pa 0x0000000087f69000</span><br><span class="line">.. .. ..0: pte 0x0000000021fdac1f pa 0x0000000087f6b000</span><br><span class="line">.. .. ..1: pte 0x0000000021fda00f pa 0x0000000087f68000</span><br><span class="line">.. .. ..2: pte 0x0000000021fd9c1f pa 0x0000000087f67000</span><br><span class="line">..255: pte 0x0000000021fdb401 pa 0x0000000087f6d000</span><br><span class="line">.. ..511: pte 0x0000000021fdb001 pa 0x0000000087f6c000</span><br><span class="line">.. .. ..510: pte 0x0000000021fdd807 pa 0x0000000087f76000</span><br><span class="line">.. .. ..511: pte 0x0000000020001c0b pa 0x0000000080007000</span><br></pre></td></tr></table></figure>
</blockquote>
<p>We actually can print the <code>PTE_FLAG</code> for each valid pte.</p>
<h1 id="Part-2-A-kernel-page-table-per-process"><a href="#Part-2-A-kernel-page-table-per-process" class="headerlink" title="Part 2  A kernel page table per process"></a>Part 2  A kernel page table per process</h1><p>  The lab is vert time-consuming ,because we are doing kernel programming  which is difficult to track the bug  and easy to make error. The points we should pay attention to :</p>
<ul>
<li>The <code>xv6</code> code is specialized for  kernel page table </li>
<li>the kernel page table  init  <code>kvminit</code>  happens in <code>pricinit</code> and <code>virto_disc</code>.</li>
<li>the memory free-up</li>
</ul>
<p>In part 3 , we will add user mapping in process’s kernel page table  to allow the kernel to dereference  the user pointer. This scheme rely on the <strong>user virtual memory range not overlapping the range of the <code>va</code> that the kernel address uses for its own instructions and data .</strong><br>       Xv6 uses virtual addresses that start at zero for user address spaces, and luckily the kernel’s memory starts at higher addresses. <strong>However, this scheme does limit the maximum size of a user process to be less than the kernel’s lowest virtual address.</strong> After the kernel has booted, that address is 0xC000000 in xv6, the address of the <code>PLIC</code> registers .You’ll need to modify xv6 to prevent user processes from growing larger than the PLIC address.<br>        Through the calculating , the<code>kernel base</code> is in  entry 2 .And the <code>PLIC</code> is in entry zero ,anything above the <code>PLIC</code>.So any user mapping below the <code>PLIC</code> will be added into process’s kernel page table .And anything above that will be identical to the kernel page table.<br>         So the entry 1-511 we can share the same page table with the kernel page table . The entry zero should be unique in process’s kernel page table. This is called <code>share</code> solution.<br>        We could have the naive  <code>copy</code> solution , when we switch in  process , we copy the ,when we switch out ,we free up the page table .</p>
<h2 id="The-init-of-process-kernel-page-table"><a href="#The-init-of-process-kernel-page-table" class="headerlink" title="The init of process kernel page table"></a>The <code>init</code> of process kernel page table</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//share the 1-511 entry and map the entry zero  for process 's kernel page table init</span></span><br><span class="line"><span class="comment">// helper function </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kvmmapkern</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 va, uint64 pa, uint64 sz, <span class="keyword">int</span> perm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (mappages(pagetable, va, sz, pa, perm) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">"kvmmap"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// according to the Q&amp;A Lecture 7</span></span><br><span class="line"><span class="keyword">pagetable_t</span> kvmcreate()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">pagetable_t</span> p = uvmcreate();</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="comment">// we share the 1-511 entry</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; <span class="number">512</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    p[i] = kernel_pagetable[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//we map the entry 0 and indentical to the kernel page table, add explicitly</span></span><br><span class="line">  <span class="comment">//we need a helper function because in kvminit function we do not</span></span><br><span class="line">  <span class="comment">//have an argument pagetable</span></span><br><span class="line"></span><br><span class="line">  kvmmapkern(p, UART0, UART0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">  kvmmapkern(p, VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">  kvmmapkern(p, CLINT, CLINT, <span class="number">0x10000</span>, PTE_R | PTE_W);</span><br><span class="line">  kvmmapkern(p, PLIC, PLIC, <span class="number">0x400000</span>, PTE_R | PTE_W);</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="The-clean-of-process-kernel-page-table"><a href="#The-clean-of-process-kernel-page-table" class="headerlink" title="The clean of process kernel page table"></a>The clean of process kernel page table</h2><p>When we free the  process’s kernel page table ,because entry 1-511 we share the same thing with the kernel page table ,so we do not need to free that memory . So we do free the lower level page table corresponding the entry zero. We can get <code>medium level</code> page table through the <code>pagetable[0]</code> ,  and free any valid pte  and corresponding <code>bottom level</code> page table .</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//according to the Q&amp;A Lecture 7</span></span><br><span class="line"><span class="comment">//a specialize kvmfree to match kvmcreate</span></span><br><span class="line"><span class="comment">//because we share the 1-511 ,only entry to consider is entry 0</span></span><br><span class="line"><span class="comment">//thus ,we only have one mid-level pagetable and possibly 512 bottom-level</span></span><br><span class="line"><span class="comment">//we never have free the PA which is pointed by the bottom-level pte</span></span><br><span class="line"><span class="comment">//because non were allocated by kvmcreate</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kvmfree</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 sz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">pte_t</span> pte = pagetable[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">pagetable_t</span> level1 = (<span class="keyword">pagetable_t</span>)PTE2PA(pte);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">pte_t</span> p = level1[i];</span><br><span class="line">    <span class="keyword">if</span> (p &amp; PTE_V)</span><br><span class="line">    &#123;</span><br><span class="line">      uint64 level2 = PTE2PA(p);</span><br><span class="line">      kfree((<span class="keyword">void</span> *) level2);</span><br><span class="line">      level1[i] =<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  kfree((<span class="keyword">void</span> *)level1);</span><br><span class="line">  kfree((<span class="keyword">void</span> *)pagetable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>According to the hints in part 2 ,we need to fix the  <code>scheduler()</code> to load the process’s kernel page table when process is running ,when the no process is running ,the  <code>scheduler()</code> will use the kernel page table.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Switch to chosen process.  It is the process's job</span></span><br><span class="line">        <span class="comment">// to release its lock and then reacquire it</span></span><br><span class="line">        <span class="comment">// before jumping back to us.</span></span><br><span class="line">        p-&gt;state = RUNNING;</span><br><span class="line">        c-&gt;proc = p;</span><br><span class="line">        w_satp(MAKE_SATP(p-&gt;kernelpgtbl));</span><br><span class="line">        sfence_vma();</span><br><span class="line">        swtch(&amp;c-&gt;context, &amp;p-&gt;context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process is done running for now.</span></span><br><span class="line">        <span class="comment">// It should have changed its p-&gt;state before coming back.</span></span><br><span class="line">        c-&gt;proc = <span class="number">0</span>;</span><br><span class="line">        w_satp(MAKE_SATP(kernel_pagetable));</span><br><span class="line">        sfence_vma();</span><br><span class="line">        found = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h1 id="Part-3-Add-user-mapping"><a href="#Part-3-Add-user-mapping" class="headerlink" title="Part 3 Add user mapping"></a>Part 3 Add user mapping</h1><p>Task: Simplify <code>copyin/copyinstr</code></p>
<p>Now for per process ,we have two page  table: one is user page table and another is a copy for kernel page table . We want to help the  simply <code>copyin</code> , when the kernel do not have user mapping ,the kernel needs to translate the <code>va =&gt; pa</code>  in software .Your task is to add user mapping to the process’s kernel page table so that the kernel can dereference the user pointers directly.</p>
<p><strong>Advantages:</strong></p>
<ul>
<li>Performance. When we need to move big bytes which can go out of <code>PGSIZE</code> , we need to <code>walkaddr</code> the <code>va</code> ,and move the <code>pa</code> .But when we have the correct user mapping ,we can using the page table.</li>
<li>We can manipulate the user data freely .Eg . when we need to fix a file in a data structure ,we may need copy in and copy out</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//according to Q&amp;A lecture 7</span></span><br><span class="line"><span class="comment">//copy ptes from the user pgtbl to process kernel pgtbl</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kvmmapuser</span><span class="params">(<span class="keyword">int</span> pid, <span class="keyword">pagetable_t</span> kpagetable, <span class="keyword">pagetable_t</span> upagetable, uint64 newsz, uint64 oldsz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint64 va;</span><br><span class="line">  <span class="keyword">pte_t</span> *upte;</span><br><span class="line">  <span class="keyword">pte_t</span> *kpte;</span><br><span class="line">  <span class="keyword">if</span> (newsz &gt; PLIC)</span><br><span class="line">    panic(<span class="string">"kvmmapuser:newsz too large"</span>);</span><br><span class="line">  <span class="keyword">for</span> (va = oldsz; va &lt; newsz; va += PGSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    upte = walk(upagetable, va, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//debug</span></span><br><span class="line">    <span class="keyword">if</span> (upte == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"kvmmapuser :0x%x 0x%x\n"</span>, va, newsz);</span><br><span class="line">      panic(<span class="string">"kvmmapuser:not upte"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((*upte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"kvmmapuser : no valid pte 0x%x 0x%x\n"</span>, va, newsz);</span><br><span class="line">      panic(<span class="string">"kvmmapuser:not valid upte"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    kpte = walk(kpagetable, va, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (kpte == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">"kvmmapuser:no kpte"</span>);</span><br><span class="line">    *kpte = *upte;</span><br><span class="line">    *kpte &amp;= ~(PTE_U | PTE_W | PTE_X);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if newsz &lt; oldsz clear ptes , not necessary</span></span><br><span class="line">  <span class="comment">//check p-&gt;sz will not use thess ptes</span></span><br><span class="line">  <span class="keyword">for</span> (va = newsz; va &lt; oldsz; va += PGSIZE)&#123;</span><br><span class="line">    kpte = walk(kpagetable, va, <span class="number">1</span>);</span><br><span class="line">    *kpte &amp;= ~PTE_V;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When we add the <code>kvmmapuser</code> in <code>fork</code> , the third argument should be new process’s page table , because  when we fork many times, the old process may exit ,the old process ‘s page table may be cleaned up.</p>
<p><strong>The course lab site</strong> :<a href="https://pdos.csail.mit.edu/6.828/2020/labs/pgtbl.html">MIT 6.S081 pgtbl</a></p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://walkerzf.github.io/2020/10/22/PgtblLab/" title="6.S081 Pgtbl Lab" target="_blank" rel="external">https://walkerzf.github.io/2020/10/22/PgtblLab/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/walkerzf" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/Halu.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/walkerzf" target="_blank"><span class="text-dark">Zhou Fang</span><small class="ml-1x">Learner .Want to be a thinker.</small></a></h3>
        <div>个人简介。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2020/10/28/TrapLab/" title="6.S081 Traps Lab"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2020/10/15/hello-world/" title="Introduction"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="Catalogue" role="button">
        <span>[&nbsp;</span><span>Catalogue</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/walkzf" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   






</body>
</html>